USE SPMEDGROUP;

GO
CREATE VIEW MEDICOS_VIEW AS
SELECT
	USUARIOS.NOME AS NOME_MÉDICO,
	MEDICOS.CRM,
	USUARIOS.EMAIL AS EMAIL_MÉDICO,	
	ESPECIALIDADES.NOME AS ESPECIALIDADE,
	CLINICA.NOME_FANTASIA AS NOME_CLÍNICA
FROM
	MEDICOS
	INNER JOIN
	USUARIOS ON MEDICOS.ID_USUARIO = USUARIOS.ID
	INNER JOIN
	ESPECIALIDADES ON ESPECIALIDADES.ID = MEDICOS.ID_ESPECIALIDADE
	INNER JOIN
	CLINICA ON CLINICA.ID = MEDICOS.ID_CLINICA
GO

SELECT * FROM MEDICOS

----------

GO
CREATE VIEW PACIENTE_VIEW AS
SELECT
	USUARIOS.NOME AS NOME_PACIENTE,
	USUARIOS.EMAIL AS EMAIL_PACIENTE,
	PRONTUARIOS.RG,
	PRONTUARIOS.CPF,
	PRONTUARIOS.DATA_NASCIMENTO,
	PRONTUARIOS.TELEFONE,
	PRONTUARIOS.ENDERECO
FROM
	PRONTUARIOS
	INNER JOIN
	USUARIOS ON PRONTUARIOS.ID_USUARIO = USUARIOS.ID
GO

SELECT * FROM USUARIOS
SELECT * FROM MEDICOS
SELECT * FROM PRONTUARIOS
SELECT * FROM CONSULTA

GO
CREATE VIEW CONSULTA_VIEW AS
SELECT
	CONSULTA.DATA_HORA_CONSULTA,
	UP.NOME AS NOME_PACIENTE,
	MED.NOME AS NOME_MEDICO,
	CONSULTA.DESCRICAO,
	SITUACOES.NOME AS STATUS
FROM
	CONSULTA
	INNER JOIN
		PRONTUARIOS ON CONSULTA.ID_PRONTUARIO = PRONTUARIOS.ID
	INNER JOIN
		MEDICOS ON CONSULTA.ID_MEDICO = MEDICOS.ID
	INNER JOIN
		USUARIOS UP ON UP.ID = PRONTUARIOS.ID_USUARIO
	INNER JOIN
		USUARIOS MED ON MED.ID = MEDICOS.ID_USUARIO
	INNER JOIN
		SITUACOES ON CONSULTA.ID_SITUACAO =  SITUACOES.ID
GO

-----TESTE:

GO
CREATE NONCLUSTERED INDEX IDX_USUARIO
      ON USUARIOS (NOME);
GO

DROP INDEX IDX_USUARIO ON USUARIOS

-----FIM TESTE




-----Contagem de usuários:
SELECT COUNT (ID)
FROM USUARIOS

SELECT COUNT (NOME)
FROM USUARIOS


-----Conversão da data de nascimento dos usuários
SELECT CONVERT (VARCHAR, DATA_NASCIMENTO, 1) FROM PRONTUARIOS


------Selecionar os médicos pelas suas especialidades
SELECT COUNT (ID)
FROM MEDICOS
WHERE ID_ESPECIALIDADE = '2'

SELECT COUNT (NOME_MÉDICO)
FROM MEDICOS_VIEW
WHERE ESPECIALIDADE = 'Pediatria'


-----Calucular a idade do usuário
CREATE PROCEDURE CALCULAR_IDADE
	@ID_USUARIO INT
AS
BEGIN
	DECLARE @DATA_NASCIMENTO DATETIME
	SET @DATA_NASCIMENTO = (SELECT DATA_NASCIMENTO FROM PRONTUARIOS WHERE ID = @ID_USUARIO)

	SELECT FLOOR(DATEDIFF(DAY, @DATA_NASCIMENTO, GETDATE()) / 365.25) AS IDADE_DO_USUARIO
END
GO

EXEC CALCULAR_IDADE 5 -- Número é o id do usuário